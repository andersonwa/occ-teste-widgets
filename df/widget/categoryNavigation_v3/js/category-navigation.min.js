define(["knockout","ccConstants","jquery","CCi18n","pubsub","ccStoreConfiguration"],function(e,t,n,r,i,s){"use strict";return{categories:e.observableArray(),storeConfiguration:s.getInstance(),onLoad:function(e){e.categories.isData=!0,e.menuName="CC-CategoryNav",e.user().catalog!=undefined&&(e.catalogId(e.user().catalog.repositoryId),e.user().catalog.rootCategories!=undefined&&e.user().catalog.rootCategories.length>0&&e.rootCategoryId(e.user().catalog.rootCategories[0].id));var r={},s={};s[t.ENDPOINT_KEY]=t.ENDPOINT_COLLECTIONS_GET_COLLECTION,s[t.IDENTIFIER_KEY]="categoryNavigation";var o=e.storeConfiguration.getFilterToUse(s);o&&(r[t.FILTER_KEY]=o),e.load("categoryList",[e.rootCategoryId(),e.catalogId(),t.CATALOG_MAX_LEVEL,e.fields()],r,function(t){var n,r,i,s;n=1,i=t.length,s=parseInt(e.maxNoOfElements(),10),i>s&&(i=s,t=t.slice(0,s));for(r=0;r<i;r+=1)e.setUiIdentifier(t[r],e.menuName,n,r,e.keypressHandler,e.navigationCategoryFocus,s,e.mouseEnter,e.checkOpenMenus,e.positionDropdown,null);e.categories(t)},e),n.Topic(i.topicNames.PAGE_CHANGED).subscribe(e.closeAllSubMenu.bind(this))},closeAllSubMenu:function(e){var t=this,r=n(n("#region-megaMenu li")[0]).siblings();t.checkOpenMenus(r)},setUiIdentifier:function(e,n,r,i,s,o,u,a,f,l,c){var h,p,d,v;if(r<=t.CATALOG_MAX_LEVEL){e.uiIdentifier=n+"_"+(i+1).toString(),e.level=r,e.itemIndex=i+1,e.hasChildCategories=!1,e.levelClass="Level"+r.toString(),e.subMenuToRight=!0,e.keybindFunc=s,e.onMenuFocus=o,e.checkOpenMenus=f,e.mouseEnterFunc=a,e.positionDropdown=l,e.parent=c,r==t.CATALOG_MAX_LEVEL&&(e.childCategories=null),h=e.childCategories;if(typeof h!="undefined"&&h!==null){e.hasChildCategories=!0,v=h.length,v>u&&(v=u,e.childCategories=e.childCategories.slice(0,u));for(var m=0;m<v;m+=1)d=e.childCategories[m],this.setUiIdentifier(d,n+"_"+(i+1).toString(),r+1,m,s,o,u,a,f,l,e)}}},keypressHandler:function(e,r){function w(){g>2&&(n(f).parent("li").removeClass("open").addClass("closed"),n(f).focus())}function E(){if(l&&p)n(c).focus(),C();else{if(!l)return!1;var e=s.parents('div[id^="region"]')[0].nextElementSibling.id,t="#"+e+" :focusable";C(),n(t).first().focus()}}function S(){if(l&&d)n(h).focus(),C();else{if(!l)return!1;var e=s.parents('div[id^="region"]')[0].previousElementSibling.id,t="#"+e+" :focusable";n(t).last().focus()}}function x(){r.stopPropagation(),n(h).length?(r.preventDefault(),n(h).focus()):g===2&&(n(f).parent("li").removeClass("open").addClass("closed"),n(f).focus())}function T(){if(l){r.stopPropagation();if(n(s[0]).parent("li").children("ul").children("li")){var e=n(s[0]).parent("li").children("ul").children("li")[0].id,t="#"+e+" :focusable";n(t).first().focus()}}else p&&(r.stopPropagation(),g===2?(n(p).prev("li").removeClass("open").addClass("closed"),n(c).focus()):(n(c).focus(),C()))}function N(){if(n(s[0]).parent("li").children("ul").length>0){var e=n(s[0]).parent("li").children("ul")[0].id,t="#"+e+" :focusable";n(t).first().focus()}}function C(){n(s[0]).parent("li").removeClass("open").addClass("closed")}function k(){!s.parent("li").hasClass("dropdown-submenu")&&!s.parent("li").hasClass("dropdown")&&s.click()}function L(){return n(s[0]).parent("li").children("ul").length>0?!0:!1}var i,s,o,u,a,f,l,c,h,p,d,v,m,g=e.level;i=this,s=n(r.target),o="#"+s.attr("id"),u=o+"_submenu",a=o+"_1",f=o.substr(0,o.lastIndexOf("_")),l=f==="#CC-CategoryNav",c=f+"_"+(parseInt(o.substr(o.lastIndexOf("_")+1),10)+1),p=n(s[0]).parent("li")[0].nextElementSibling,d=n(s[0]).parent("li")[0].previousElementSibling,h=f+"_"+(parseInt(o.substr(o.lastIndexOf("_")+1),10)-1);var y=o.split("_"),b=y[0]+"_"+y[1];v=f+"_submenu",m=r.which?r.which:r.keyCode,r.shiftKey&&m==t.KEY_CODE_TAB&&(m=t.KEY_CODE_SHIFT_TAB);switch(m){case t.KEY_CODE_ENTER:break;case t.KEY_CODE_SPACE:n(s[0]).parent("li").hasClass("open")?C():(r.stopPropagation(),n(s[0]).parent("li").addClass("open"),i.positionDropdown()),r.stopPropagation();break;case t.KEY_CODE_TAB:return E(),!1;case t.KEY_CODE_SHIFT_TAB:return S(),!1;case t.KEY_CODE_LEFT_ARROW:l||(L()?e.subMenuToRight||N():e.parent!=null&&e.parent.subMenuToRight&&w());break;case t.KEY_CODE_UP_ARROW:return C(),l||x(),!1;case t.KEY_CODE_RIGHT_ARROW:l?T():L()?e.subMenuToRight&&N():e.parent!=null&&!e.parent.subMenuToRight&&w();break;case t.KEY_CODE_DOWN_ARROW:return!n(o).parent("li").hasClass("open")&&l?(r.stopPropagation(),n(o).parent("li").addClass("open")):T(),!1}return!0},navigationCategoryFocus:function(e,t){var r,i;return t.stopPropagation(),r=n(t.target).parent("li"),i=r.parent().parent(),n(t.target).parent().hasClass("dropdown-submenu")&&t.preventDefault(),r.hasClass("open")?r.removeClass("open").addClass("closed"):(t.stopPropagation(),r.addClass("open"),this.positionDropdown()),!0},mouseEnter:function(e,t){var r=n(t.target),i=n(r[0]).parent("li").siblings();this.checkOpenMenus(i),this.positionDropdown()},checkOpenMenus:function(e){var t=e,r=t.length;for(var i=0;i<r;i+=1){n(t[i]).hasClass("open")&&n(t[i]).removeClass("open").addClass("closed");var s=n(t[i]).children("ul").children("li");this.checkOpenMenus(s)}return!1},positionDropdown:function(){var e=n("#"+this.uiIdentifier+"_submenu");if(e.length>0&&this.subMenuToRight){var t=e.offset().left+e.width(),r=n("body").innerWidth(),i=3;t+i>r&&(this.subMenuToRight=!1,e.addClass("move-to-left"),n(window).one("resize.bs.dropdown",function(){this.subMenuToRight=!0;var e=n("#"+this.uiIdentifier+"_submenu");e.length>0&&e.removeClass("move-to-left")}.bind(this)))}}}})