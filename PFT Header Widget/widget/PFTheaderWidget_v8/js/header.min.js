define(["knockout","pubsub","notifications","CCi18n","ccConstants","navigation","ccLogger","jquery","ccNumber","storageApi"],function(e,t,n,r,i,s,o,u,a,f){"use strict";return{linkList:e.observableArray(),WIDGET_ID:"header",cartVisible:e.observable(!1),ignoreBlur:e.observable(!1),selectedStore:e.observable(),selectedStoreLogo:e.observable(),floatMenu:e.observable(!1),onLoad:function(t){var n=!1;o.info("on header load cart contains "+t.cart().items().length),t.linkList.removeAll();for(var a in t.links())t.linkList.push(t.links()[a]);t.cartLinkText=e.computed(function(){var e,n,i,s=t.site().selectedPriceListGroup().currency.symbol,e=t.formatPrice(t.cart().subTotal(),t.site().selectedPriceListGroup().currency.fractionalDigits);return s.match(/^[0-9a-zA-Z]+$/)&&(s+=" "),i=t.ccNumber(t.cart().numberOfItems()),n=r.t("ns.common:resources.cartDropDownText",{count:t.cart().numberOfItems(),formattedCount:i,currency:s,totalPrice:e}),n},t);var l=navigator.userAgent.match(i.IPAD_STRING)!=null;l&&u(window).on("touchend",function(e){u(e.target).closest("#dropdowncart").length||(u("#dropdowncart > .content").fadeOut("slow"),u("#dropdowncart").removeClass("active")),u(e.target).closest("#languagedropdown").length||(u("#languagedropdown > .content").fadeOut("slow"),u("#languagedropdown").removeClass("active"));if(!!u(e.target).closest("#CC-megaMenu").length)return u(e.target).closest("a").next("ul").length===0?!0:!n&&u(window).width()>=i.VIEWPORT_TABLET_UPPER_WIDTH?(n=!0,!1):n&&u(e.target).closest("a").attr("href")===s.getRelativePath()?!1:!0;u("li.cc-desktop-dropdown:hover > ul.dropdown-menu").css("display","none"),n=!1}),this.controlSearch(),this.toggleMobileMenu(),this.toggleSearchMobile(),this.toggleMobileNavigation(),console.log("Alteração"),u(document).on("mouseleave",".pft-header-dropdown-minicart-widget",function(){console.log("mouseleave"),u(".pft-header-dropdown-minicart-widget").find(".content").fadeOut("fast")}),u(document).on("mouseover",".cc-cartlink-anchor",function(){console.log("hover"),u(".pft-header-dropdown-minicart-widget").find(".content").fadeIn("fast")});var c=f.getInstance().getItem("pft.selectedStore")||"CS";t.selectedStore(c),t.changeSelectStoreLogo(c),u.Topic("STORE_CHANGED").publish(),u.Topic("STORE_CHANGED").subscribe(function(e){console.info("STORE_CHANGED",e),u(document).ajaxComplete(function(){u(".menu-item.colecao").length===0&&u(".nav.navbar-nav").prepend('<li class="menu-item colecao"><a href="/a-colecao" class="Level1" title="A Coleção"><span>A Coleção</span></a></li>')})}),u(document).on("ajaxStop",function(){u(".menu-item.colecao").length===0&&u(".nav.navbar-nav").prepend('<li class="menu-item colecao"><a href="/a-colecao" class="Level1" title="A Coleção"><span>A Coleção</span></a></li>')}),t.floatMenuControl(),this.loadStoreOnLoad(),this.helloBar()},floatMenuControl:function(){u(window).on("scroll",function(){window.scrollY>200?this.floatMenu(!0):this.floatMenu(!1)}.bind(this))},markSelectStoreMenu:function(e){u.Topic("STORE_CHANGED").publish(e),f.getInstance().setItem("pft.selectedStore",e),this.selectedStore(e),this.changeSelectStoreLogo(e),console.log("layoutName: ",this.layoutName),e=="RS"?((window.location.pathname.indexOf("home")!=-1||window.location.pathname.indexOf("/")!=-1||window.location.pathname.indexOf("carmen-steffens")!=-1)&&window.location.pathname.indexOf("quem-somos-raphael-steffens")==-1&&s.goTo("/raphael-steffens/sapatos-masculinos"),window.location.pathname.indexOf("/quem-somos?store=CS")!=-1&&s.goTo("/quem-somos-raphael-steffens?store=RS")):e=="CS"?((window.location.pathname.indexOf("/carmen-steffens/")!=-1||window.location.pathname.indexOf("/a-colecao")!=-1)&&s.goTo("/home"),window.location.pathname.indexOf("/raphael-steffens")!=-1&&s.goTo("/home"),window.location.pathname.indexOf("/quem-somos-raphael-steffens")!=-1&&s.goTo("/quem-somos?store=CS")):e=="CSC"&&s.goTo("/cs-club/sapatos-cs-club")},changeSelectStoreLogo:function(e){console.log("changeSelectStoreLogo");switch(e){case"CS":this.selectedStoreLogo(JSON.parse('{"route": "/home","src": "/file/general/logo.jpg","alt": "Carmen Steffens"}'));break;case"RS":this.selectedStoreLogo(JSON.parse('{"route": "/raphael-steffens/sapatos-masculinos","src": "/file/general/rs-logo.svg","alt": "Rafael Steffens"}'));break;case"CSC":this.selectedStoreLogo(JSON.parse('{"route": "/home","src": "/file/general/cs-club-logo.svg","alt": "CS Club"}'))}},getParameterByName:function(e,t){t||(t=window.location.href),e=e.replace(/[\[\]]/g,"\\$&");var n=new RegExp("[?&]"+e+"(=([^&#]*)|&|#|$)"),r=n.exec(t);return r?r[2]?decodeURIComponent(r[2].replace(/\+/g," ")):"":null},loadStoreOnLoad:function(){u(document).one("ajaxStop",function(){var e=this.getParameterByName("store");console.log("store",e);switch(e){case"CS":this.markSelectStoreMenu("CS"),u(".top-main-header__link-item--carmen").eq(1).click();break;case"RS":this.markSelectStoreMenu("RS"),u(".top-main-header__link-item--rafael").eq(1).click();break;case"CSC":this.markSelectStoreMenu("CSC"),u(".top-main-header__link-item--csclub").eq(1).click()}}.bind(this))},beforeAppear:function(e){},keypressHandler:function(e,t){var n,r,s;n=this,r=u(t.target),s=t.which?t.which:t.keyCode,t.shiftKey&&s==i.KEY_CODE_TAB&&(s=i.KEY_CODE_SHIFT_TAB);switch(s){case i.KEY_CODE_TAB:r[0].id!=="CC-header-cart-total"&&(this.handleCartClosedAnnouncement(),u("#dropdowncart").removeClass("active"));break;case i.KEY_CODE_SHIFT_TAB:r[0].id==="CC-header-cart-total"&&(this.handleCartClosedAnnouncement(),u("#dropdowncart").removeClass("active"))}return!0},showDropDownCart:function(){this.cartOpenTimeout&&clearTimeout(this.cartOpenTimeout),this.cartVisible(!0),u("#CC-header-cart-total").attr("aria-label",r.t("ns.common:resources.miniCartOpenedText")),u("#CC-header-cart-empty").attr("aria-label",r.t("ns.common:resources.miniCartOpenedText")),n.emptyGrowlMessages(),this.computeDropdowncartHeight(),this["pft-header-dropdown-minicart"].currentSection(1),this.computeMiniCartItems(),u("#dropdowncart").addClass("active"),u("#dropdowncart > .content").fadeIn("slow");var e=this,t=navigator.userAgent.match(i.IPAD_STRING)!=null;t&&u(document).on("touchend",function(t){u(t.target).closest("#dropdowncart").length||(e.handleCartClosedAnnouncement(),u("#dropdowncart > .content").fadeOut("slow"),u("#dropdowncart").removeClass("active"))})},hideDropDownCart:function(){return this.cartVisible(!1),u("#CC-header-cart-total").attr("aria-label",r.t("ns.common:resources.miniCartClosedText")),u("#CC-header-cart-empty").attr("aria-label",r.t("ns.common:resources.miniCartClosedText")),setTimeout(function(){u("#CC-header-cart-total").attr("aria-label",r.t("ns.header:resources.miniShoppingCartTitle")),u("#CC-header-cart-empty").attr("aria-label",r.t("ns.header:resources.miniShoppingCartTitle"))},1e3),u("#dropdowncart > .content").fadeOut("slow"),u("#dropdowncart").removeClass("active"),this.cartOpenTimeout&&clearTimeout(this.cartOpenTimeout),!0},toggleDropDownCart:function(){u("#dropdowncart").hasClass("active")?this.hideDropDownCart():this.showDropDownCart()},handleRemoveFromCart:function(){u.Topic(t.topicNames.CART_REMOVE).publishWith(this.productData(),[{message:"success",commerceItemId:this.commerceItemId}])},handlePlaceHolderRemove:function(){u.Topic(t.topicNames.PLACE_HOLDER_REMOVE).publish(this)},handleValidateCart:function(e,n){if(e.user().isUserProfileEdited())return!0;e.cart().validatePrice=!0,s.getRelativePath()==e.links().cart.route&&e.cart().skipPriceChange(!0),u.Topic(t.topicNames.LOAD_CHECKOUT).publishWith(e.cart(),[{message:"success"}])},handleDropDownCheckout:function(e,t){this.hideDropDownCart(),this.handleValidateCart(e,t)},skipToContentHandler:function(){var e,t,n=this;for(t=0;t<n.length;t++)if(n[t].type()===i.REGION_TYPE_BODY)break;t==n.length?e=u("#main .row .redBox div:first-child").attr("id"):e="region-"+n[t].name();var r="#"+e+" :focusable";r&&u(r).first().focus()},processNrParameter:function(e,t){if(e.indexOf("(")===-1)return e;var n=e.split("(")[1],r=n.split(")")[0],i=r.split(","),s="";for(var o=0;o<i.length;o++){if(i[o].indexOf("product.priceListPair")!==-1&&t==="currency-picker")continue;if(i[o].indexOf("product.language")!==-1&&t==="language-picker")continue;s===""?s=i[o]:s=s+","+i[o]}return s=e.split("(")[0]+"("+s,s=s+")"+e.split(")")[1],s},handleCartClosedAnnouncement:function(){u("#dropdowncart").hasClass("active")&&(u("#alert-modal-change").text(r.t("ns.common:resources.miniCartClosedText")),u("#CC-header-cart-total").attr("aria-label",r.t("ns.header:resources.miniShoppingCartTitle")),u("#CC-header-cart-empty").attr("aria-label",r.t("ns.header:resources.miniShoppingCartTitle")))},controlSearch:function(){u(document).on("click",".label-hidden",function(e){e.preventDefault(),u(".form-search .search").addClass("active"),u(".bg-search").addClass("active"),u("#CC-headerWidget-Search").eq(0).focus()}),u(document).on("click",".bg-search",function(e){e.preventDefault(),u(".form-search .search").removeClass("active"),u(".bg-search").removeClass("active")}),u(document).on("click","#searchSubmit",function(e){e.preventDefault(),u(this).parents(".form-search").submit(),console.info("Busca enviada")})},toggleMobileMenu:function(){u("#overlay").length===0?u("body").append('<div id="overlay"></div>'):!1,u(document).on("click","#toggle-navigation",function(e){e.preventDefault(),u("html").addClass("menu-is-open"),u("#overlay").fadeIn()}),u("#overlay").on("click",function(e){e.preventDefault(),u("html").removeClass("menu-is-open"),u(".mobile-navigation__top-navigation--sub").removeClass("active"),u(this).fadeOut()})},toggleSearchMobile:function(){u(document).on("click",".toggle-search",function(e){e.preventDefault(),u(".form-search").find("label.label-hidden").click()})},toggleMobileNavigation:function(){u(document).on("click",'.mobile-navigation__bottom-navigation a[href="#"]',function(e){e.preventDefault(),u(this).next("ul").slideToggle()}),u(document).on("click",'.mobile-navigation__top-navigation a[href="#"]',function(e){e.preventDefault(),u(this).next(".mobile-navigation__top-navigation--sub").addClass("active")}),u(document).on("click",".mobile-navigation__top-navigation--back",function(){u(this).parent(".mobile-navigation__top-navigation--sub").removeClass("active")})},setCookie:function(e,t,n,r){var i=r||"/",s=n||1,o=new Date;o.setTime(o.getTime()+s*24*60*60*1e3);var u="expires="+o.toGMTString();document.cookie=e+"="+t+"; "+u+"; path="+i},getCookie:function(e){var t=e+"=",n=document.cookie.split(";");for(var r=0;r<n.length;r++){var i=n[r].trim();if(i.indexOf(t)===0)return i.substring(t.length,i.length)}return""},removeCookie:function(e,t){var n=t||"/";document.cookie=e+"=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path="+n},helloBar:function(){var e=this,t=function(e){return['<div class="hello-bar '+e+'">','<div class="row">','<div class="container">',"<span>Estamos de site novo. Para efetuar compras, <strong>crie um novo cadastro!</strong></span>",'<a href="#" id="toggleCadastre-se" class="hello-bar__btn">Clique aqui</a>',"</div>","</div>","</div>"].join(" ")};u("#headerBar").append(t("hidden-xs hidden-sm hidden-md")),u("#page").prepend(t("visible-md visible-sm visible-xs")),u(".hello-bar").on("click",".hello-bar--close",function(t){t.preventDefault(),u(".hello-bar").slideUp("fast"),u("html").removeClass("has-hello-bar"),e.setCookie("helloBar","true",.04)}),u(".hello-bar").on("click",".hello-bar__btn",function(e){e.preventDefault(),u("#CC-loginHeader-login").click()})}}})