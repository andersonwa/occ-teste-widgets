define(["jquery","knockout","ccConstants","ccRestClient","notifications","pubsub","storageApi","navigation"],function(e,t,n,r,i,s,o,u){"use strict";return{elementName:"pft-header-currency-picker",defaultPriceListGroup:t.observable(),activePriceListGroups:t.observableArray([]),currencyDropdownVisible:t.observable(!1),currentCurrencyPosition:t.observable(),onLoad:function(t){var n=this,r=null;n.loadPicker(t.site()),n.handleCurrencyChange=function(i){var s=this,o=t.site().selectedPriceListGroup();n.currentCurrencyPosition(i);var a=!1;for(var f=0;f<t.cart().items().length;f++)if(t.cart().items()[f].childItems){a=!0;break}if(a)r=this,e("#cc-cpqconfirmationmodalpane").modal();else{r&&(s=r),n.storePriceListGroupInLocalStorage(s),n.activePriceListGroups()[i]=o,n.sortCurrencies(),n.hideCurrencyDropDown();if(u.getRelativePath().indexOf(t.links().searchresults.route)!==-1){var l=decodeURIComponent(window.location.search);l=l.replace("?","");var c=l.split("&"),h="";for(var f=0;f<c.length;f++)c[f].split("=")[0]==="Nr"?h===""?h="Nr="+t.processNrParameter(c[f].split("=")[1],"currency-picker"):h=h+"&"+"Nr="+t.processNrParameter(c[f].split("=")[1],"currency-picker"):h===""?h=c[f]:h=h+"&"+c[f];var p=u.getBaseURL()+"/"+u.getPath()+"?"+h;window.location.assign(p)}else window.location.reload()}},t.site().activePriceListGroups.subscribe(function(e){n.loadPicker(t.site())})},handleDeleteConfigurableItems:function(e,t){for(var n=0;n<e.cart().items().length;n++)e.cart().items()[n].childItems&&e.cart().removeItem(e.cart().items()[n]);this.handleCurrencyChange(this.currentCurrencyPosition())},loadPicker:function(e){var t=this;e.priceListGroup.defaultPriceListGroup&&(t.defaultPriceListGroup(null),t.defaultPriceListGroup(e.priceListGroup.defaultPriceListGroup));if(e.priceListGroup.activePriceListGroups.length){t.activePriceListGroups.removeAll();for(var i=0;i<e.priceListGroup.activePriceListGroups.length;i++)t.activePriceListGroups.push(e.priceListGroup.activePriceListGroups[i])}var s=JSON.parse(r.getStoredValue(n.LOCAL_STORAGE_CURRENCY)),o=JSON.parse(r.getStoredValue(n.LOCAL_STORAGE_PRICELISTGROUP_ID));if(!s&&t.defaultPriceListGroup())e.selectedPriceListGroup(t.defaultPriceListGroup()),t.storePriceListGroupInLocalStorage(t.defaultPriceListGroup());else{var u=!1;for(var i=0;i<t.activePriceListGroups().length;i++)if(s.repositoryId===t.activePriceListGroups()[i].currency.repositoryId&&o==t.activePriceListGroups()[i].id){e.selectedPriceListGroup(t.activePriceListGroups()[i]),t.storePriceListGroupInLocalStorage(t.activePriceListGroups()[i]),u=!0;break}!u&&t.defaultPriceListGroup()&&(e.selectedPriceListGroup(t.defaultPriceListGroup()),t.storePriceListGroupInLocalStorage(t.defaultPriceListGroup()))}var a=e.selectedPriceListGroup().id;for(var i=0;i<t.activePriceListGroups().length;i++)t.activePriceListGroups()[i].id===a&&t.activePriceListGroups.splice(i,1);t.sortCurrencies()},sortCurrencies:function(){var e=this;e.activePriceListGroups.sort(function(e,t){return e.currency.currencyCode==t.currency.currencyCode?0:e.currency.currencyCode<t.currency.currencyCode?-1:1})},storePriceListGroupInLocalStorage:function(e){var i=this;r.setStoredValue(n.LOCAL_STORAGE_CURRENCY,t.toJSON(e.currency)),r.setStoredValue(n.LOCAL_STORAGE_PRICELISTGROUP_ID,t.toJSON(e.id))},keypressCurrencyHandler:function(t,r){var i,s,o;i=this,s=e(r.target),o=r.which?r.which:r.keyCode,r.shiftKey&&o==n.KEY_CODE_TAB&&(o=n.KEY_CODE_SHIFT_TAB);var u="CC-header-Currency-"+(i.activePriceListGroups().length-1);switch(o){case n.KEY_CODE_TAB:s[0].id===u&&i.hideCurrencyDropDown();break;case n.KEY_CODE_SHIFT_TAB:s[0].id==="CC-header-currency-link"&&i.hideCurrencyDropDown()}return!0},showCurrencyDropDown:function(){var t=this;e("#headerCurrencyPicker").addClass("active"),t.currencyDropdownVisible(!0),i.emptyGrowlMessages(),e(document).on("mouseleave","#headerCurrencyPicker",function(){t.hideCurrencyDropDown()});var r=navigator.userAgent.match(n.IPAD_STRING)!=null;r&&e(document).on("touchend",function(n){e(n.target).closest("#headerCurrencyPicker").length||t.hideCurrencyDropDown()})},hideCurrencyDropDown:function(){return this.currencyDropdownVisible(!1),e("#headerCurrencyPicker").removeClass("active"),!0},toggleCurrencyDropDown:function(){e("#headerCurrencyPicker").hasClass("active")?this.hideCurrencyDropDown():this.showCurrencyDropDown()}}})