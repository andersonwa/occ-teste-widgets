define(["jquery","knockout","notifier","ccPasswordValidator","pubsub","CCi18n","ccConstants","navigation","ccLogger","koValidate","./jquery.inputmask.bundle.min.js","./ko.mask.js"],function(e,t,n,r,i,s,o,u,a,f,l,c){"use strict";var h,p,d,v="";return{elementName:"pft-login-registration",modalMessageType:t.observable(""),modalMessageText:t.observable(""),showErrorMessage:t.observable(!1),userCreated:t.observable(!1),ignoreBlur:t.observable(!1),cpf:t.observable(""),onLoad:function(t){var a=this;h=t,p=this,t.user().ignoreEmailValidation(!1),t.user().delaySuccessNotification()&&(n.sendSuccess(t.WIDGET_ID,t.translate("updateSuccessMsg"),!0),t.user().delaySuccessNotification(!1)),e.Topic(i.topicNames.USER_AUTO_LOGIN_SUCCESSFUL).subscribe(function(r){r.widgetId===t.WIDGET_ID&&(a.userCreated(!0),a.hideLoginModal(),a.showErrorMessage(!1),n.clearSuccess(t.WIDGET_ID),n.sendSuccess(t.WIDGET_ID,t.translate("createAccountSuccess")),e(window).scrollTop("0"))}),e.Topic(i.topicNames.USER_RESET_PASSWORD_SUCCESS).subscribe(function(t){a.hideAllSections(),e("#CC-forgotPasswordMessagePane").show()}),e.Topic(i.topicNames.USER_RESET_PASSWORD_FAILURE).subscribe(function(e){n.sendError(t.WIDGET_ID,e.message,!0)}),e.Topic(i.topicNames.USER_PASSWORD_GENERATED).subscribe(function(n){e("#alert-modal-change").text(s.t("ns.common:resources.createNewPasswordModalOpenedText")),a.hideAllSections(),t.user().showCreateNewPasswordMsg(!0),t.user().hasFieldLevelError(!1),t.user().createNewPasswordError(s.t("ns.common:resources.createNewPasswordError")),t.user().resetPassword(),e("#CC-createNewPassword-oldPassword-error").empty(),e("#CC-createNewPassword-password-error").empty(),e("#CC-createNewPassword-password-embeddedAssistance").empty(),e("#CC-createNewPassword-oldPassword").removeClass("invalid"),e("#CC-createNewPassword-password").removeClass("invalid"),e("#CC-createNewPasswordPane").show(),e("#CC-createNewPassword-oldPassword").focus(),t.user().oldPassword.isModified(!1)}),e.Topic(i.topicNames.USER_PASSWORD_EXPIRED).subscribe(function(n){e("#alert-modal-change").text(s.t("ns.common:resources.resetPasswordModalOpenedText")),t.user().ignoreEmailValidation(!1),a.hideAllSections(),e("#CC-forgotPasswordSectionPane").show(),e("#CC-forgotPwd-input").focus(),t.user().emailAddressForForgottenPwd(""),t.user().emailAddressForForgottenPwd.isModified(!1),t.user().forgotPasswordMsg(s.t("ns.common:resources.resetPwdText"))}),e.Topic(i.topicNames.USER_PROFILE_PASSWORD_UPDATE_FAILURE).subscribe(function(n){t.user().showCreateNewPasswordMsg(!1);if(n.errorCode==o.UPDATE_EXPIRED_PASSWORD_OLD_PASSWORD_INCORRECT)e("#CC-createNewPassword-oldPassword-error").css("display","block"),e("#CC-createNewPassword-oldPassword-error").text(s.t("ns.common:resources.oldPasswordsDoNotMatch")),e("#CC-createNewPassword-oldPassword").addClass("invalid"),t.user().hasFieldLevelError(!0);else if(n.errorCode==o.USER_EXPIRED_PASSWORD_POLICIES_ERROR){e("#CC-createNewPassword-password-error").css("display","block"),e("#CC-createNewPassword-password-error").text(s.t("ns.common:resources.passwordPoliciesErrorText")),e("#CC-createNewPassword-password").addClass("invalid"),e("#CC-createNewPassword-password-embeddedAssistance").css("display","block");var i=r.getAllEmbeddedAssistance(t.passwordPolicies(),!0);e("#CC-createNewPassword-password-embeddedAssistance").text(i),t.user().hasFieldLevelError(!0)}else t.user().createNewPasswordError(n.message),t.user().showCreateNewPasswordMsg(!0),t.user().hasFieldLevelError(!1)}),e.Topic(i.topicNames.USER_PROFILE_PASSWORD_UPDATE_SUCCESSFUL).subscribe(function(n){a.hideAllSections(),e("#CC-createNewPasswordMessagePane").show(),e("#CC-headermodalpane").on("hide.bs.modal",function(){e("#CC-createNewPasswordMessagePane").css("display")=="block"&&t.user().handleLogin()})}),e.Topic(i.topicNames.USER_CREATION_FAILURE).subscribe(function(e){e.widgetId===t.WIDGET_ID&&(t.user().resetPassword(),a.modalMessageType("error"),a.modalMessageText(e.message),a.showErrorMessage(!0))}),e.Topic(i.topicNames.USER_LOGIN_FAILURE).subscribe(function(e){a.modalMessageType("error"),e.errorCode&&e.errorCode===o.ACCOUNT_ACCESS_ERROR_CODE?a.modalMessageText(s.t("ns.common:resources.accountError")):a.modalMessageText(s.t("ns.common:resources.loginError")),a.showErrorMessage(!0)}),e.Topic(i.topicNames.USER_LOGIN_SUCCESSFUL).subscribe(function(r){a.hideLoginModal(),a.showErrorMessage(!1),n.clearSuccess(t.WIDGET_ID),e("#CC-loginHeader-myAccount").focus(),e("#CC-loginHeader-myAccount-mobile").focus()}),u.setLoginHandler(function(n){e.Topic(i.topicNames.PAGE_READY).subscribe(function(r){if(r){r.pageId==undefined&&(r.pageId="");var i=[];u.loginHandlerPage?i=u.loginHandlerPage.split("/"):u.loginHandlerPage==""&&(i=[""]);if(u.loginHandlerPage==undefined||u.loginHandlerPage==null)return}n&&n[0]&&n[0].linkToRedirect&&(t.user().pageToRedirect(n[0].linkToRedirect),t.user().loggedInUserName()!=""&&!t.user().isUserSessionExpired()&&t.user().handleSessionExpired()),setTimeout(function(){e("#CC-headermodalpane").modal("show"),a.hideAllSections(),a.userCreated(!1),e("#CC-loginUserPane").show(),e("#CC-headermodalpane").on("shown.bs.modal",function(){!t.user().loggedIn()&&!t.user().isUserLoggedOut()&&t.user().login()&&t.user().login()!=""&&t.user().isUserSessionExpired()?(t.user().populateUserFromLocalData(!0),e("#CC-login-password-input").focus(),t.user().password.isModified(!1)):(e("#CC-login-input").focus(),t.user().login.isModified(!1)),u.loginHandlerPage=null}),e("#CC-headermodalpane").on("hidden.bs.modal",function(){!a.userCreated()&&!t.user().loggedIn()&&(e("#CC-loginUserPane").css("display")=="block"||e("#CC-registerUserPane").css("display")=="block"||e("#CC-createNewPasswordPane").css("display")=="block"||e("#CC-forgotPasswordSectionPane").css("display")=="block"||e("#CC-forgotPasswordMessagePane").css("display")=="block")&&a.cancelLoginModal(t)})},o.PROFILE_UNAUTHORIZED_DEFAULT_TIMEOUT)})}),e(document).on("hide.bs.modal","#CC-headermodalpane",function(){e("#CC-loginUserPane").css("display")=="block"?e("#alert-modal-change").text(s.t("ns.common:resources.loginModalClosedText")):e("#CC-registerUserPane").css("display")=="block"?e("#alert-modal-change").text(s.t("ns.common:resources.registrationModalClosedText")):e("#CC-forgotPasswordSectionPane").css("display")=="block"?t.user().forgotPasswordMsg()==s.t("ns.common:resources.forgotPwdText")?e("#alert-modal-change").text(s.t("ns.common:resources.forgottenPasswordModalClosedText")):e("#alert-modal-change").text(s.t("ns.common:resources.resetPasswordModalClosedText")):e("#CC-createNewPasswordPane").css("display")=="block"&&e("#alert-modal-change").text(s.t("ns.common:resources.createNewPasswordModalClosedText"))}),e(document).on("show.bs.modal","#CC-headermodalpane",function(){e("#CC-loginUserPane").css("display")=="block"?e("#alert-modal-change").text(s.t("ns.common:resources.loginModalOpenedText")):e("#CC-registerUserPane").css("display")=="block"?e("#alert-modal-change").text(s.t("ns.common:resources.registrationModalOpenedText")):e("#CC-forgotPasswordSectionPane").css("display")=="block"?t.user().forgotPasswordMsg()==s.t("ns.common:resources.forgotPwdText")?e("#alert-modal-change").text(s.t("ns.common:resources.forgottenPasswordModalOpenedText")):e("#alert-modal-change").text(s.t("ns.common:resources.resetPasswordModalOpenedText")):e("#CC-createNewPasswordMessagePane").css("display")=="block"&&e("#alert-modal-change").text(s.t("ns.common:resources.createNewPasswordModalOpenedText"))}),t.Validacaoes=function(){f.rules.cpf===void 0&&(f.rules.cpf={validator:function(e){var t,n,r,i,s,o,u,a,f;e=e.replace(/[^\d]+/g,"");if(e==="")return!1;if(e.length==11){if(e=="00000000000"||e=="11111111111"||e=="22222222222"||e=="33333333333"||e=="44444444444"||e=="55555555555"||e=="66666666666"||e=="77777777777"||e=="88888888888"||e=="99999999999")return!1;t=0;for(r=0;r<9;r++)t+=parseInt(e.charAt(r))*(10-r);n=11-t%11;if(n==10||n==11)n=0;if(n!=parseInt(e.charAt(9)))return!1;t=0;for(r=0;r<10;r++)t+=parseInt(e.charAt(r))*(11-r);n=11-t%11;if(n==10||n==11)n=0;return n!=parseInt(e.charAt(10))?!1:!0}return!1},message:"Invalid CPF."}),f.registerExtenders()},t.Validacaoes(),a.cpf.extend({required:{params:!0,message:"Obrigatório"},cpf:{params:!0,message:"Número incorreto."}})},removeMessageFromPanel:function(){var e=this,t=e.id(),r=e.type();n.deleteMessage(t,r)},emailAddressFocused:function(e){return this.ignoreBlur&&this.ignoreBlur()?!0:(this.user().ignoreEmailValidation(!0),!0)},emailAddressLostFocus:function(e){return this.ignoreBlur&&this.ignoreBlur()?!0:(this.user().ignoreEmailValidation(!1),!0)},passwordFieldFocused:function(e){return this.ignoreBlur&&this.ignoreBlur()?!0:(this.user().ignorePasswordValidation(!0),!0)},passwordFieldLostFocus:function(e){return this.ignoreBlur&&this.ignoreBlur()?!0:(this.user().ignorePasswordValidation(!1),!0)},confirmPwdFieldFocused:function(e){return this.ignoreBlur&&this.ignoreBlur()?!0:(this.user().ignoreConfirmPasswordValidation(!0),!0)},confirmPwdFieldLostFocus:function(e){return this.ignoreBlur&&this.ignoreBlur()?!0:(this.user().ignoreConfirmPasswordValidation(!1),!0)},handleLabelsInIEModals:function(){!navigator.userAgent.match(/Trident/)||e("#CC-LoginRegistrationModal label").removeClass("inline")},registerUser:function(t,r){if("click"===r.type||("keydown"===r.type||"keypress"===r.type)&&r.keyCode===13){n.clearError(this.WIDGET_ID);var u=this,a={};t.user().emailAddress.isModified(!0),t.user().newPassword.isModified(!0),t.user().confirmPassword.isModified(!0),t.user().firstName.isModified(!0),t.user().lastName.isModified(!0),p.cpf.isModified(!0);var f=t.user().emailAddress.isValid()&&t.user().newPassword.isValid()&&t.user().confirmPassword.isValid()&&t.user().firstName.isValid()&&t.user().lastName.isValid()&&p.cpf.isValid();f&&(a[o.PROFILE_EMAIL]=t.user().emailAddress(),a[o.PROFILE_PASSWORD]=t.user().newPassword(),a[o.PROFILE_FIRST_NAME]=t.user().firstName(),a[o.PROFILE_LAST_NAME]=t.user().lastName(),a[o.PROFILE_RECEIVE_EMAIL]=t.user().emailMarketingMails()?"yes":"no",a.cpf=p.cpf(),h.user().adapter.persistCreate(o.ENDPOINT_CREATE_PROFILE,o.ENDPOINT_CREATE_PROFILE,a,function(t){d=!0,v={cpf:a.cpf},h.user().emailAddress(e("#CC-userRegistration-emailAddress").val()),h.user().password(e("#CC-userRegistration-password").val()),h.user().login(h.user().emailAddress()),e.Topic(i.topicNames.USER_LOGIN_SUBMIT).publishWith(h.user(),[{message:"success"}])},function(t){t.errorCode==o.CREATE_PROFILE_USER_EXISTS&&n.sendError(h.WIDGET_ID,s.t("ns.common:resources.accountAlreadyExists"),!0),e.Topic(i.topicNames.USER_CREATION_FAILURE).publish(t)}))}return!0},hideLoginModal:function(){e("#CC-headermodalpane").modal("hide"),e("body").removeClass("modal-open"),e(".modal-backdrop").remove()},handleLogin:function(t,r){if("click"===r.type||("keydown"===r.type||"keypress"===r.type)&&r.keyCode===13)n.clearError(this.WIDGET_ID),t.user().validateLogin()&&(t.user().updateLocalData(!1,!1),e.Topic(i.topicNames.USER_LOGIN_SUBMIT).publishWith(t.user(),[{message:"success"}]));return!0},handleCancel:function(t,r){if("click"===r.type||("keydown"===r.type||"keypress"===r.type)&&r.keyCode===13)n.clearError(this.WIDGET_ID),t.user().isUserSessionExpired()&&(e.Topic(i.topicNames.USER_LOGOUT_SUBMIT).publishWith([{message:"success"}]),this.hideLoginModal());return!0},savePassword:function(e,t){if("click"===t.type||("keydown"===t.type||"keypress"===t.type)&&t.keyCode===13)e.user().ignoreConfirmPasswordValidation(!1),e.user().isPasswordValid()&&e.user().updateExpiredPassword();return!0},cancelLoginModal:function(e){if(e.hasOwnProperty("user")){e.user().handleCancel();if(e.user().pageToRedirect()&&e.user().pageToRedirect()==e.links().checkout.route&&e.cart().items().length>0){var t=e.user().pageToRedirect();e.user().pageToRedirect(null),u.goTo(t)}else u.cancelLogin();e.user().pageToRedirect(null),n.clearError(e.WIDGET_ID),e.user().clearUserData(),e.user().profileRedirect()}else u.cancelLogin()},handleLogout:function(t){if(t.isUserProfileEdited())return!0;n.clearSuccess(this.WIDGET_ID),n.clearError(this.WIDGET_ID),t.updateLocalData(t.loggedinAtCheckout(),!1),e.Topic(i.topicNames.USER_LOGOUT_SUBMIT).publishWith([{message:"success"}])},cancelRegistration:function(e){n.clearSuccess(this.WIDGET_ID),n.clearError(this.WIDGET_ID),this.hideLoginModal(),e.user().reset(),this.showErrorMessage(!1),e.user().pageToRedirect(null)},clickRegistration:function(t){n.clearSuccess(this.WIDGET_ID),n.clearError(this.WIDGET_ID),t.reset(),this.hideAllSections(),e("#CC-registerUserPane").show(),this.showErrorMessage(!1),e("#CC-headermodalpane").on("shown.bs.modal",function(){e("#CC-userRegistration-firstname").focus(),t.firstName.isModified(!1)})},clickLogin:function(t){n.clearSuccess(this.WIDGET_ID),n.clearError(this.WIDGET_ID),t.reset(),this.hideAllSections(),e("#CC-loginUserPane").show(),this.showErrorMessage(!1),e("#CC-headermodalpane").on("shown.bs.modal",function(){!t.loggedIn()&&t.login()&&t.login()!=""&&t.isUserSessionExpired()?(t.populateUserFromLocalData(!0),e("#CC-login-password-input").focus(),t.password.isModified(!1)):(e("#CC-login-input").focus(),t.login.isModified(!1)),u.loginHandlerPage=null})},handleMouseUp:function(e){return this.ignoreBlur(!1),e.user().ignoreConfirmPasswordValidation(!1),!0},handleMouseDown:function(e){return this.ignoreBlur(!0),e.user().ignoreConfirmPasswordValidation(!0),!0},handleModalDownClick:function(e,t){return t.target===t.currentTarget&&(this.ignoreBlur(!0),this.user().ignoreConfirmPasswordValidation(!0)),!0},showRegistrationSection:function(t){e("#alert-modal-change").text(s.t("ns.common:resources.registrationModalOpenedText")),this.hideAllSections(),e("#CC-registerUserPane").show(),e("#CC-userRegistration-firstname").focus(),t.user().firstName.isModified(!1),n.clearError(this.WIDGET_ID),n.clearSuccess(this.WIDGET_ID),t.user().reset(),this.showErrorMessage(!1)},showForgotPasswordSection:function(t){e("#alert-modal-change").text(s.t("ns.common:resources.forgottenPasswordModalOpenedText")),t.ignoreEmailValidation(!1),this.hideAllSections(),e("#CC-forgotPasswordSectionPane").show(),e("#CC-forgotPwd-input").focus(),t.emailAddressForForgottenPwd(""),t.emailAddressForForgottenPwd.isModified(!1),t.forgotPasswordMsg(s.t("ns.common:resources.forgotPwdText"))},hideAllSections:function(){e("#CC-loginUserPane").hide(),e("#CC-registerUserPane").hide(),e("#CC-forgotPasswordSectionPane").hide(),e("#CC-forgotPasswordMessagePane").hide(),e("#CC-createNewPasswordMessagePane").hide(),e("#CC-createNewPasswordPane").hide()},resetForgotPassword:function(e,t){if("click"===t.type||("keydown"===t.type||"keypress"===t.type)&&t.keyCode===13)e.user().ignoreEmailValidation(!1),e.user().emailAddressForForgottenPwd.isModified(!0),e.user().emailAddressForForgottenPwd&&e.user().emailAddressForForgottenPwd.isValid()&&e.user().resetForgotPassword();return!0}}})