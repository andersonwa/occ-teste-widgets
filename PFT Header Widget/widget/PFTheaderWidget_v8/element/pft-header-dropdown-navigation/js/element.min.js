define(["knockout","ccConstants","notifications","pubsub","CCi18n","spinner","ccStoreConfiguration","storageApi"],function(e,t,n,r,i,s,o,u){"use strict";return{elementName:"pft-header-dropdown-navigation",categories:e.observableArray(),storeConfiguration:o.getInstance(),catalogMenuBlock:"#CC-megaMenu",menuOptions:{parent:"#CC-megaMenu",posTop:"40px",posLeft:"30%"},isMobile:e.observable(!1),store:e.observable(),onLoad:function(e){var t=this;t.store(u.getInstance().getItem("pft.selectedStore")||"CS"),$.Topic("STORE_CHANGED").subscribe(function(e){console.info("STORE_CHANGED",e),t.store(e)}),e.menuName="CC-CategoryNav",$(window).resize(function(){t.checkResponsiveFeatures($(window).width())}),$(document).on("mouseover","li.cc-desktop-dropdown",function(){$(this).children("ul.dropdown-menu").css({display:"block",top:"auto"}),navigator.userAgent.indexOf("Firefox")!=-1?$("#CC-product-listing-sortby-controls select.form-control").hide():$("#CC-product-listing-sortby-controls select.form-control").css("visibility","hidden")}),$(document).on("mouseout","li.cc-desktop-dropdown",function(){$(this).children("ul.dropdown-menu").css({display:"none"}),navigator.userAgent.indexOf("Firefox")!=-1?$("#CC-product-listing-sortby-controls select.form-control").show():$("#CC-product-listing-sortby-controls select.form-control").css("visibility","visible")}),$(document).on("keydown","a.Level1",function(e){e.which===9&&e.shiftKey?$(this).next("ul.dropdown-menu").css({display:"none"}):e.which==27?$(this).next("ul.dropdown-menu").css({display:"none"}):e.which==9?$(this).next().children("a.Level2").parents("ul.dropdown-menu").css({display:"block",top:"auto"}):e.which==13&&$(this).next("ul.dropdown-menu").css({display:"none"})}),$(document).on("keydown","a.Level2",function(e){e.which==27?$(this).parents("ul.dropdown-menu").css({display:"none"}):e.which==9?$(this).next().children("a.Level3").parents("ul.dropdown-menu").css({display:"block",top:"auto"}):e.which==13&&$(this).parents("ul.dropdown-menu").css({display:"none"})}),$(document).on("keydown","a.Level3",function(e){e.which==27?$(this).parents("ul.dropdown-menu").css({display:"none"}):e.which==9?$(this).parent("li").next("li").children("a.Level3").length==0&&$(this).parents("div.child-category-container").next("div.child-category-container").children("a.Level2").length==0&&$(this).parents("ul.dropdown-menu").parent("li.cc-desktop-dropdown").next("li.cc-desktop-dropdown").focus():e.which==13&&navigator.userAgent.indexOf("MSIE")==-1&&!navigator.userAgent.match(/Trident.*rv\:11\./)&&$(this).parents("ul.dropdown-menu").css({display:"none"})}),$(document).on("blur","a.Level3",function(e){$(this).parent("li").next("li").children("a.Level3").length==0&&$(this).parents("div.child-category-container").next("div.child-category-container").children("a.Level2").length==0&&$(this).parents("ul.dropdown-menu").css({display:"none"})}),$(document).on("focus","li.cc-desktop-dropdown",function(){$(this).children("ul.dropdown-menu").css({display:"block",top:"auto"})}),e.user()!=undefined&&e.user().catalogId&&e.catalogId(e.user().catalogId()),t.setCategoryList(e)},beforeAppear:function(t){var n=this;e.isObservable(n.user)&&n.user()&&e.isObservable(n.user().catalogId)&&n.user().catalogId()&&n.user().catalogId()!=n.catalogId()&&(n.categories([]),n.createSpinner(),n.catalogId(n.user().catalogId()),n.setCategoryList(),n.destroySpinner())},setCategoryList:function(e){var n=this,r={},i={};i[t.ENDPOINT_KEY]=t.ENDPOINT_COLLECTIONS_GET_COLLECTION,i[t.IDENTIFIER_KEY]="megaMenuNavigation";var s=n.storeConfiguration.getFilterToUse(i);s&&(r[t.FILTER_KEY]=s),console.log("widget.load",e.load),e.load("categoryList",[e.rootCategoryId(),e.catalogId(),1e3],r,function(t){n.checkResponsiveFeatures($(window).width());var r,i;r=t.length,i=parseInt(e.maxNoOfElements(),1e3),r>i&&(r=i,t=t.slice(0,i)),console.log(e.categories),n.categories.valueWillMutate();for(var s=0;s<t.length;s++){var o=$.extend({},t[s]);o.hasOwnProperty("childCategories")?(o.showCaret=!0,delete o.childCategories):o.showCaret=!1,n.categories.push(o),console.log("category",o)}n.categories.valueHasMutated();var u=!1;$(document).one("mouseover focus","#CC-megaMenu",function(){u||(n.categories(t),u=!0)}),$(document).ready(function(){u||(n.categories(t),u=!0)})},e)},destroySpinner:function(){var e=this;$(e.catalogMenuBlock).removeClass("loadingIndicator"),s.destroy(1)},createSpinner:function(){var e=this;$(e.catalogMenuBlock).css("position","relative"),e.menuOptions.loadingText="Loading",s.createWithTimeout(e.menuOptions,5e3)},catMenuClick:function(e,t){return $.Topic(r.topicNames.OVERLAYED_GUIDEDNAVIGATION_HIDE).publish([{message:"success"}]),$.Topic(r.topicNames.UPDATE_FOCUS).publishWith({WIDGET_ID:"productListing"},[{message:"success"}]),!0},checkResponsiveFeatures:function(e){e>978?this.isMobile(!1):e<=978&&this.isMobile(!0)},navigationCategoryClick:function(e,t){n.emptyGrowlMessages();var r,i;t.stopPropagation(),r=$(t.target).parent("li"),i=r.parent().parent(),$(t.target).parent().hasClass("dropdown-submenu")&&t.preventDefault();if(r.hasClass("open"))r.removeClass("open").addClass("closed");else if(i.hasClass("open")){$(".dropdown-submenu.open").removeClass("open").addClass("closed");if(r.hasClass("closed"))return r.removeClass("closed").addClass("open"),!1;r.removeClass("open").addClass("closed")}return!0},megaMenuClick:function(e,t){return n.emptyGrowlMessages(),$.Topic(r.topicNames.OVERLAYED_GUIDEDNAVIGATION_HIDE).publish([{message:"success"}]),t.stopPropagation(),!0}}})