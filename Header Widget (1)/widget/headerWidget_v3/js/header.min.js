define(["knockout","pubsub","notifications","CCi18n","ccConstants","navigation","jquery","ccNumber"],function(e,t,n,r,i,s,o,u){"use strict";return{linkList:e.observableArray(),WIDGET_ID:"header",cartVisible:e.observable(!1),ignoreBlur:e.observable(!1),onLoad:function(t){var n=!1;t.linkList.removeAll();for(var u in t.links())t.linkList.push(t.links()[u]);t.cartLinkText=e.computed(function(){var e,n,i,s=t.site().selectedPriceListGroup().currency.symbol,e=t.formatPrice(t.cart().subTotal(),t.site().selectedPriceListGroup().currency.fractionalDigits);return s.match(/^[0-9a-zA-Z]+$/)&&(s+=" "),i=t.ccNumber(t.cart().numberOfItems()),n=r.t("ns.common:resources.cartDropDownText",{count:t.cart().numberOfItems(),formattedCount:i,currency:s,totalPrice:e}),n},t);var a=navigator.userAgent.match(i.IPAD_STRING)!=null;a&&o(window).on("touchend",function(e){o(e.target).closest("#dropdowncart").length||(o("#dropdowncart > .content").fadeOut("slow"),o("#dropdowncart").removeClass("active")),o(e.target).closest("#languagedropdown").length||(o("#languagedropdown > .content").fadeOut("slow"),o("#languagedropdown").removeClass("active"));if(!!o(e.target).closest("#CC-megaMenu").length)return o(e.target).closest("a").next("ul").length===0?!0:!n&&o(window).width()>=i.VIEWPORT_TABLET_UPPER_WIDTH?(n=!0,!1):n&&o(e.target).closest("a").attr("href")===s.getRelativePath()?!1:!0;o("li.cc-desktop-dropdown:hover > ul.dropdown-menu").css("display","none"),n=!1})},keypressHandler:function(e,t){var n,r,s;n=this,r=o(t.target),s=t.which?t.which:t.keyCode,t.shiftKey&&s==i.KEY_CODE_TAB&&(s=i.KEY_CODE_SHIFT_TAB);switch(s){case i.KEY_CODE_TAB:r[0].id!=="CC-header-cart-total"&&(this.handleCartClosedAnnouncement(),o("#dropdowncart").removeClass("active"));break;case i.KEY_CODE_SHIFT_TAB:r[0].id==="CC-header-cart-total"&&(this.handleCartClosedAnnouncement(),o("#dropdowncart").removeClass("active"))}return!0},showDropDownCart:function(){this.cartOpenTimeout&&clearTimeout(this.cartOpenTimeout),this.cartVisible(!0),o("#CC-header-cart-total").attr("aria-label",r.t("ns.common:resources.miniCartOpenedText")),o("#CC-header-cart-empty").attr("aria-label",r.t("ns.common:resources.miniCartOpenedText")),n.emptyGrowlMessages(),this.computeDropdowncartHeight(),this["header-dropdown-minicart"].currentSection(1),this.computeMiniCartItems(),o("#dropdowncart").addClass("active"),o("#dropdowncart > .content").fadeIn("slow");var e=this;o(document).on("mouseleave","#dropdowncart",function(){e.handleCartClosedAnnouncement(),o("#dropdowncart > .content").fadeOut("slow"),o(this).removeClass("active")});var t=navigator.userAgent.match(i.IPAD_STRING)!=null;t&&o(document).on("touchend",function(t){o(t.target).closest("#dropdowncart").length||(e.handleCartClosedAnnouncement(),o("#dropdowncart > .content").fadeOut("slow"),o("#dropdowncart").removeClass("active"))})},hideDropDownCart:function(){return this.cartVisible(!1),o("#CC-header-cart-total").attr("aria-label",r.t("ns.common:resources.miniCartClosedText")),o("#CC-header-cart-empty").attr("aria-label",r.t("ns.common:resources.miniCartClosedText")),setTimeout(function(){o("#CC-header-cart-total").attr("aria-label",r.t("ns.header:resources.miniShoppingCartTitle")),o("#CC-header-cart-empty").attr("aria-label",r.t("ns.header:resources.miniShoppingCartTitle"))},1e3),o("#dropdowncart > .content").fadeOut("slow"),o("#dropdowncart").removeClass("active"),this.cartOpenTimeout&&clearTimeout(this.cartOpenTimeout),!0},toggleDropDownCart:function(){o("#dropdowncart").hasClass("active")?this.hideDropDownCart():this.showDropDownCart()},handleRemoveFromCart:function(){o.Topic(t.topicNames.CART_REMOVE).publishWith(this.productData(),[{message:"success",commerceItemId:this.commerceItemId}])},handlePlaceHolderRemove:function(){o.Topic(t.topicNames.PLACE_HOLDER_REMOVE).publish(this)},handleValidateCart:function(e,n){if(e.user().isUserProfileEdited())return!0;e.cart().validatePrice=!0,s.getRelativePath()==e.links().cart.route&&e.cart().skipPriceChange(!0),o.Topic(t.topicNames.LOAD_CHECKOUT).publishWith(e.cart(),[{message:"success"}])},handleDropDownCheckout:function(e,t){this.hideDropDownCart(),this.handleValidateCart(e,t)},skipToContentHandler:function(){var e=o("#region-navbar").attr("id");if(!e){e=o("#region-megaMenu").next().attr("id");if(typeof e=="undefined"||e===null)e=o("#region-header").next().attr("id")}else e=o("#region-navbar").next().attr("id");var t="#"+e+" :focusable";o(t).first().focus()},processNrParameter:function(e,t){if(e.indexOf("(")===-1)return e;var n=e.split("(")[1],r=n.split(")")[0],i=r.split(","),s="";for(var o=0;o<i.length;o++){if(i[o].indexOf("product.priceListPair")!==-1&&t==="currency-picker")continue;if(i[o].indexOf("product.language")!==-1&&t==="language-picker")continue;s===""?s=i[o]:s=s+","+i[o]}return s=e.split("(")[0]+"("+s,s=s+")"+e.split(")")[1],s},handleCartClosedAnnouncement:function(){o("#dropdowncart").hasClass("active")&&(o("#alert-modal-change").text(r.t("ns.common:resources.miniCartClosedText")),o("#CC-header-cart-total").attr("aria-label",r.t("ns.header:resources.miniShoppingCartTitle")),o("#CC-header-cart-empty").attr("aria-label",r.t("ns.header:resources.miniShoppingCartTitle")))}}})